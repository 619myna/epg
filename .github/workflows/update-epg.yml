name: Update EPG Daily

on:
  schedule:
    - cron: '30 0 * * *'  # æ¯å¤©å‡Œæ™¨0ç‚¹30åˆ†è¿è¡Œ
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: ''
        
    - name: æ£€æŸ¥æ–‡ä»¶
      run: |
        echo "ğŸ“ é¡¹ç›®æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo ""
        echo "ğŸ“„ æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨:"
        [ -f categories.js ] && echo "âœ… categories.js å­˜åœ¨" || echo "âŒ categories.js ä¸å­˜åœ¨"
        [ -f downloader.js ] && echo "âœ… downloader.js å­˜åœ¨" || echo "âŒ downloader.js ä¸å­˜åœ¨"
        [ -f processor.js ] && echo "âœ… processor.js å­˜åœ¨" || echo "âŒ processor.js ä¸å­˜åœ¨"
        [ -f splitter.js ] && echo "âœ… splitter.js å­˜åœ¨" || echo "âŒ splitter.js ä¸å­˜åœ¨"
        [ -f index.js ] && echo "âœ… index.js å­˜åœ¨" || echo "âŒ index.js ä¸å­˜åœ¨"
        
    - name: å®‰è£…ä¾èµ–
      run: |
        rm -f package-lock.json
        rm -rf node_modules
        npm install --no-audit --no-fund
        
    - name: è¿è¡ŒEPGå¤„ç†å™¨
      run: npm start
      
    - name: æ˜¾ç¤ºç”Ÿæˆæ–‡ä»¶
      run: |
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la output/
        echo ""
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        echo "XMLæ–‡ä»¶: $(find output -name "*.xml" | wc -l) ä¸ª"
        echo "JSONæ–‡ä»¶: $(find output -name "*.json" | wc -l) ä¸ª"
        echo "æ€»æ–‡ä»¶: $(find output -type f | wc -l) ä¸ª"
        
    - name: éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./output
        keep_files: false
        commit_message: "è‡ªåŠ¨æ›´æ–°EPGæ•°æ® - ${{ github.run_number }}"
