name: Update EPG Daily

on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œ
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        # ä¸è¦ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…ç¼“å­˜æŸåçš„æ–‡ä»¶
        cache: ''
        
    - name: å®‰è£…ä¾èµ–
      run: |
        # æ¸…ç†å¯èƒ½æŸåçš„æ–‡ä»¶
        rm -f package-lock.json
        rm -rf node_modules
        
        # å®‰è£…ä¾èµ–
        npm install --no-audit --no-fund
        
    - name: è¿è¡ŒEPGå¤„ç†å™¨
      run: npm start
      
    - name: æ˜¾ç¤ºç”Ÿæˆæ–‡ä»¶
      run: |
        echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨:"
        ls -la output/
        echo ""
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        echo "XMLæ–‡ä»¶: $(find output -name "*.xml" | wc -l) ä¸ª"
        echo "JSONæ–‡ä»¶: $(find output -name "*.json" | wc -l) ä¸ª"
        echo "æ€»æ–‡ä»¶: $(find output -type f | wc -l) ä¸ª"
        
    - name: éƒ¨ç½²åˆ°GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./output
        keep_files: false
        commit_message: "è‡ªåŠ¨æ›´æ–°EPGæ•°æ® - ${{ github.run_number }}"
        
    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬ï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        files: output/*
        tag_name: epg-${{ github.run_number }}
        name: EPGæ•°æ® v${{ github.run_number }}
        body: |
          EPGæ•°æ®è‡ªåŠ¨æ›´æ–°
          
          æ›´æ–°æ—¶é—´: ${{ github.run_number }}
          
          åŒ…å«:
          - 34ä¸ªçœä»½XMLæ–‡ä»¶
          - 7ä¸ªé€šç”¨åˆ†ç±»XMLæ–‡ä»¶
          - å®Œæ•´æ•°æ®æ–‡ä»¶
          - ç´¢å¼•æ–‡ä»¶
          
          ä½¿ç”¨æ–¹æ³•:
          - åŒ—äº¬: bj.xml
          - å¹¿ä¸œ: guangdong.xml
          - å¤®è§†: cctv.xml
          - å®Œæ•´: all.xml
        draft: false
        prerelease: false
